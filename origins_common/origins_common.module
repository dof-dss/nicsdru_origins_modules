<?php

/**
 * @file
 * Contains origins_common.module.
 */

include_once 'inc/layout_builder_search.inc';

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use Drupal\node\Entity\NodeType;

/**
 * Implements hook_help().
 */
function origins_common_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the origins_common module.
    case 'help.page.origins_common':
      $output = '';
      $output .= '<h3>' . t("About") . '</h3>';
      $output .= '<p>' . t("A common set of Drupal components.") . '</p>';
      $output .= '<h4>' . t("Layout Builder Search Indexing") . '</h4>';
      $output .= '<p>' . t("To enable Layout Builder search indexing:");
      $output .= '<ul><li>' . t("Ensure the Node Type has at least one Layout Builder enabled display.") . '</li>';
      $output .= '<li>' . t("Edit the Node Type and click 'Enable search indexing' under the 'Layout Builder search indexing' option") . '</li>';
      $output .= '<li>' . t("Choose the display mode that will be used to generate the search index content and save the form.") . '</li>';
      $output .= '<li>' . t("Within a Node edit form click 'Enable search indexing for this node' under the 'Layout Builder Search Indexing ' option.") . '</li>';
      $output .= '<li>' . t("Within a Node edit form click 'Enable search indexing for this node' under the 'Layout Builder Search Indexing ' option.") . '</li>';
      // Display Search API instructions.
      if (\Drupal::moduleHandler()->moduleExists('search_api')) {
        $output .= '<li>' . t('Under your <a href=":searchapi">Search API</a> server index, include the \'field_lb_search_content\' field for indexing.', [':searchapi' => Url::fromRoute('search_api.overview')->toString()]) . '</li>';
      }
      $output .= '</ul>';
      $output .= '<h4>' . t("Entity reference field HTML list display formatter") . '</h4>';
      $output .= '<p>' . t("Displays entity references as OL or UL HTML lists with the option of assigning a class to the list.");

      return $output;

    default:
  }
}

/**
 * Implements hook_entity_presave().
 */
function origins_common_entity_presave(EntityInterface $entity) {

  // Process Layout Builder search options on node type edit form submit.
  if ($entity instanceof NodeType) {
    layout_builder_search_node_type_presave($entity);
  }

  // Process Layout Builder search on node edit form submit.
  if ($entity instanceof Node) {
    layout_builder_search_node_presave($entity);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function origins_common_form_node_type_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  layout_builder_search_node_type_form_alter($form, $form_state, $form_id);
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function origins_common_form_node_form_alter(&$form, $form_state, $form_id) {
  layout_builder_search_node_edit_form_alter($form, $form_state, $form_id);
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function origins_common_form_entity_embed_dialog_alter(&$form, FormStateInterface $form_state) {
  // Hide alignment options that are displayed by default in
  // media_browser_responsive_images module as we don't need
  // that option in NICS sites.
  $form['attributes']['data-align']['#default_value'] = 'right';
  $form['attributes']['data-align']['#access'] = FALSE;
}

/**
 * Implements hook_preprocess_table().
 */
function origins_taxonomy_access_preprocess_table(&$variables) {
  // Add new 'Revision Number' column to the node revisions tab.
  //
  // Making this change in preprocess is not beautiful, but seems
  // to be the only workable solution as the 'diff' module has
  // already been enabled and has taken over the core route with
  // its own controller. If we created our own controller to do
  // this then we would have to call the contrib controller,
  // which does not sound like a good idea.
  if (\Drupal::routeMatch()->getRouteName() == 'entity.node.version_history') {
    // Add 'Revision Number' column header.
    $new_head = ['tag' => 'th', 'content' => ['#markup' => t('Revision number')]];
    // Insert this new column after the first one.
    // Use array_splice as we don't know exactly how many columns there will be
    // (and this code should work whether the 'diff' module has been enabled or
    // not).
    array_splice($variables['header'], 1, 0, [$new_head]);
    if (isset($variables['header']['select_column_one'])) {
      $variables['header']['select_column_one']['content'] = ['#markup' => t('Compare revision 1')];
    }
    if (isset($variables['header']['select_column_two'])) {
      $variables['header']['select_column_two']['content'] = ['#markup' => t('Compare revision 2')];
    }
    // Loop through the rows and add the revision number column to each.
    foreach ($variables['rows'] as $idx => $row) {
      $this_version = '';
      if (isset($row['cells'][3]['content']['#links'])) {
        // Cheekily extract current revision from the 'revert' button link.
        $this_url = $row['cells'][3]['content']['#links']['revert']['url'];
        if (isset($this_url)) {
          $this_version = $this_url->getRouteParameters()['node_revision'];
        }
      }
      else {
        // There is no 'revert' button in this row,
        // therefore it must be the current version.
        //
        // Cannot manage to extract the revision id from this row
        // anywhere so we'll (reluctantly) have to load up the full node.
        $node = \Drupal::routeMatch()->getParameter('node');
        $this_version = $node->getRevisionId();
      }
      $new_col = ['tag' => 'td', 'content' => ['#markup' => $this_version]];
      // Insert this new column after the first one.
      // Use array_splice as we don't know exactly how many columns there
      // will be (and this code should work whether the 'diff' module has
      // been enabled or not).
      array_splice($variables['rows'][$idx]['cells'], 1, 0, [$new_col]);
    }
  }
}
